# PukiWiki to Markdown 変換ツール 仕様書

## 1. 概要

### 1.1 目的
PukiWikiのwikiページデータおよび添付ファイルをMarkdown形式に変換し、ファイルシステムに出力する。

### 1.2 スコープ
- **対象**: PukiWikiのwikiフォルダ(ページデータ)とattachフォルダ(添付ファイル)
- **出力**: Markdownファイル、添付ファイル、ディレクトリ構造

---

## 2. CLI仕様

### 2.1 コマンド形式
```bash
pukiwiki-to-md --wiki <wikiフォルダ> --attach <attachフォルダ> --output <出力フォルダ> [オプション]
```

### 2.2 必須オプション

| オプション | 短縮形 | 説明 | 例 |
|----------|-------|------|-----|
| `--wiki` | `-w` | PukiWikiのwikiフォルダパス | `./pukiwiki/wiki` |
| `--attach` | `-a` | PukiWikiのattachフォルダパス | `./pukiwiki/attach` |
| `--output` | `-o` | 出力先フォルダパス | `./output` |

### 2.3 オプション引数

| オプション | 短縮形 | デフォルト値 | 説明 |
|----------|-------|------------|------|
| `--encoding` | `-e` | `utf-8` | 入力ファイルの文字エンコーディング |
| `--help` | `-h` | - | ヘルプを表示 |
| `--version` | `-v` | - | バージョンを表示 |

### 2.4 実行例

```bash
# 基本的な使用方法(UTF-8)
pukiwiki-to-md -w ./pukiwiki/wiki -a ./pukiwiki/attach -o ./output

# EUC-JPエンコーディングのPukiWikiを変換
pukiwiki-to-md -w ./wiki -a ./attach -o ./output --encoding euc-jp

# ヘルプ表示
pukiwiki-to-md --help
```

### 2.5 終了コード

| コード | 説明 |
|-------|------|
| `0` | 正常終了 |
| `1` | エラー終了(ディレクトリが存在しない、権限エラーなど) |

---

## 3. 入力仕様

### 3.1 PukiWiki wikiフォルダ構造

```
wiki/
├── A4C6A4ACA4EFA4B0.txt         # エンコードされたファイル名
├── B5ECBDB1.txt
├── 3AConfig2FPlugin.txt         # :config で始まるファイル(除外対象)
├── index.html                   # ディレクトリインデックス(除外対象)
├── .htaccess                    # アクセス制御(除外対象)
└── ...
```

#### 3.1.1 ファイル名エンコーディング
- **形式**: URLエンコード(パーセント記号なし)
- **エンコード方式**: 2文字ごとに`%`を挿入してURLデコード
- **例**:
  - エンコード済み: `A4C6A4ACA4EFA4B0`
  - デコード処理: `%A4%C6%A4%AC%A4%EF%A4%B0`
  - 結果: `てがわぐ` (EUC-JPバイト列をデコード)

#### 3.1.2 ファイル内容
- **拡張子**: `.txt`
- **文字エンコーディング**: UTF-8またはEUC-JP(--encodingオプションで指定)
- **フォーマット**: PukiWiki記法

#### 3.1.3 処理対象の判定条件

wikiページとして処理するファイルは以下の条件を**すべて満たす**もの:

1. 拡張子が `.txt`
2. デコード後のページ名が `:` で始まらない

この条件により、以下のファイルは自動的に除外される:
- `:config`関連ファイル（例: `:config/Plugin`）
- `:RenameLog`などのシステムページ
- `index.html`: ディレクトリインデックス(拡張子が`.txt`でない)
- `.htaccess`: アクセス制御ファイル(拡張子が`.txt`でない)

**注意事項:**
- ページ名のチェックは、ファイル名をデコードした後に行われます
- これにより、EUC-JPとUTF-8の両方のエンコーディングで正しく動作します

### 3.2 PukiWiki attachフォルダ構造

```
attach/
├── A4C6A4ACA4EFA4B0_A5A4A5E1A5BCA5B82E706E67       # <エンコードされたページ名>_<エンコードされたファイル名>
├── A4C6A4ACA4EFA4B0_A5A4A5E1A5BCA5B82E706E67.log   # 添付ファイルのメタデータ(除外対象)
├── A4C6A4ACA4EFA4B0_A5C9A5ADA5E5A5E1A5F3A5C82E706466
├── index.html                                     # ディレクトリインデックス(除外対象)
├── .htaccess                                      # アクセス制御(除外対象)
└── ...
```

#### 3.2.1 ファイル命名規則
- **形式**: `<エンコードされたページ名>_<エンコードされた添付ファイル名>`
- **エンコード方式**: ページ名とファイル名(拡張子含む)の両方がURLエンコード(パーセント記号なし)
- **区切り文字**: `_`(アンダースコア、エンコードされていない)
- **例**:
  - エンコード済み: `A4C6A4B9A4C8_A5B9A5AFA5EAA5FCA5F3A5B7A5E7A5C3A5C82E706E67`
  - デコード後: ページ名 `テスト` + ファイル名 `スクリーンショット.png` (`.png` = `2E706E67`)

#### 3.2.2 処理対象の判定条件

添付ファイルとして処理するファイルは以下の条件を**すべて満たす**もの:

1. ファイル名が `<文字列>_<文字列>` の形式(アンダースコアを含む)
2. 拡張子が `.log` ではない

この条件により、以下のファイルは自動的に除外される:
- `.log`ファイル: 添付ファイルのメタデータ
- `index.html`: ディレクトリインデックス(アンダースコアを含まない)
- `.htaccess`: アクセス制御ファイル(アンダースコアを含まない)

---

## 4. 出力仕様

### 4.1 ディレクトリ構造

PukiWikiのページ名に含まれる`/`(スラッシュ)をディレクトリ階層として解釈する。

#### 入力例
```
wiki/
├── A4D7A4EDA4B8A4A7A4AFA4C8.txt           # プロジェクト
├── A4D7A4EDA4B8A4A7A4AFA4C82FA4BFA4B9.txt # プロジェクト/タスク
└── ...
```

#### 出力例
```
output/
├── プロジェクト.md
├── プロジェクト/
│   └── タスク.md
└── ...
```

### 4.2 Markdownファイル仕様

#### 4.2.1 ファイル名
- **形式**: `<デコードされたページ名>.md`
- **文字エンコーディング**: UTF-8
- **例**: `プロジェクト概要.md`

#### 4.2.2 ファイル内容
- **フォーマット**: Markdown(GitHub Flavored Markdown準拠)
- **文字エンコーディング**: UTF-8
- **改行コード**: LF(`\n`)

### 4.3 添付ファイル仕様

#### 4.3.1 配置場所
対応するMarkdownファイルと同じディレクトリ

#### 4.3.2 ファイル命名規則
```
<ページ名>_attachment_<元のファイル名>
```

#### 4.3.3 例

| 元のPukiWiki添付ファイル | デコード後 | 出力ファイル名 |
|---------------------|---------|--------------|
| `A4C6A4B9A4C8_A5A4A5E1A5BCA5B82E706E67` | ページ名: `テスト`<br>ファイル名: `イメージ.png` | `テスト_attachment_イメージ.png` |
| `A4D7A4EDA4B8A4A7A4AFA4C8_A5C9A5ADA5E5A5E1A5F3A5C82E706466` | ページ名: `プロジェクト`<br>ファイル名: `ドキュメント.pdf` | `プロジェクト_attachment_ドキュメント.pdf` |

---

## 5. 変換仕様

### 5.1 見出し

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `*見出し1` | `# 見出し1` | レベル1見出し |
| `**見出し2` | `## 見出し2` | レベル2見出し |
| `***見出し3` | `### 見出し3` | レベル3見出し |

**例:**
```
入力: *はじめに
出力: # はじめに
```

### 5.2 リスト

#### 5.2.1 箇条書きリスト

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `-項目` | `- 項目` | レベル1 |
| `--項目` | `    - 項目` | レベル2(インデント4スペース) |
| `---項目` | `        - 項目` | レベル3(インデント8スペース) |

**例:**
```
入力:
-項目1
--項目1-1
---項目1-1-1
-項目2

出力:
- 項目1
    - 項目1-1
        - 項目1-1-1
- 項目2
```

#### 5.2.2 番号付きリスト

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `+項目` | `1. 項目` | レベル1 |
| `++項目` | `    1. 項目` | レベル2(インデント4スペース) |
| `+++項目` | `        1. 項目` | レベル3(インデント8スペース) |

### 5.3 テキスト装飾

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `''強調''` | `**強調**` | 太字 |
| `'''イタリック'''` | `*イタリック*` | 斜体 |
| `%%取り消し%%` | `~~取り消し~~` | 取り消し線 |
| `&br;` | `<br>` | 改行 |

### 5.4 リンク

#### 5.4.1 内部リンク

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `[[ページ名]]` | `[ページ名](相対パス)` | 相対パスで解決 |
| `[[テキスト>ページ名]]` | `[テキスト](相対パス)` | リンクテキスト指定 |
| `[[カテゴリ/ページ]]` | `[カテゴリ/ページ](相対パス)` | 階層リンク |

**相対パス解決の例:**

同じディレクトリ内:
```
現在のページ: プロジェクト/タスク
リンク: [[プロジェクト/概要]]
出力: [プロジェクト/概要](概要.md)
```

ルートレベルから階層へ:
```
現在のページ: トップページ
リンク: [[プロジェクト/タスク]]
出力: [プロジェクト/タスク](プロジェクト/タスク.md)
```

階層からルートレベルへ:
```
現在のページ: プロジェクト/タスク
リンク: [[トップページ]]
出力: [トップページ](../トップページ.md)
```

異なる階層間（兄弟ディレクトリ）:
```
現在のページ: プロジェクトA/タスク
リンク: [[プロジェクトB/概要]]
出力: [プロジェクトB/概要](../プロジェクトB/概要.md)
```

#### 5.4.2 外部リンク

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `[[テキスト:https://example.com]]` | `[テキスト](https://example.com)` | |
| `https://example.com` | `https://example.com` | URL直接記述 |

### 5.5 画像・添付ファイル

ファイルの拡張子によって、画像表示（`![]()`またはHTMLの`<img>`タグ）またはファイルリンク（`[]()`）に変換されます。

**画像ファイル拡張子**: `.png`, `.jpg`, `.jpeg`, `.gif`, `.bmp`, `.svg`, `.webp`

#### 5.5.1 画像ファイル参照

##### 5.5.1.1 基本形式（サイズ指定なし）

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `#ref(image.png)` | `![](ページ名_attachment_image.png)` | 画像表示 |
| `#ref(image.png,テキスト)` | `![テキスト](ページ名_attachment_image.png)` | altテキスト指定 |
| `&ref(icon.png);` | `![](ページ名_attachment_icon.png)` | 画像表示（インライン） |
| `&ref(icon.png,アイコン);` | `![アイコン](ページ名_attachment_icon.png)` | altテキスト指定（インライン） |

**例:**
```
ページ名: プロジェクト概要
入力: #ref(screenshot.png)
出力: ![](概要_attachment_screenshot.png)
```

##### 5.5.1.2 サイズ指定あり（HTMLタグ使用）

サイズ指定がある場合、HTMLの`<img>`タグに変換されます。`#ref`と`&ref`の両方でサポートされています。

| PukiWiki | HTML | 備考 |
|----------|------|------|
| `#ref(image.png,300x200)` | `<img src="ページ名_attachment_image.png" width="300" height="200">` | 幅×高さ指定 |
| `#ref(image.png,300x)` | `<img src="ページ名_attachment_image.png" width="300">` | 幅のみ指定 |
| `#ref(image.png,x200)` | `<img src="ページ名_attachment_image.png" height="200">` | 高さのみ指定 |
| `#ref(image.png,300w)` | `<img src="ページ名_attachment_image.png" width="300">` | 幅指定（ピクセル） |
| `#ref(image.png,200h)` | `<img src="ページ名_attachment_image.png" height="200">` | 高さ指定（ピクセル） |
| `#ref(image.png,50%)` | `<img src="ページ名_attachment_image.png" style="width: 50%">` | パーセント指定 |
| `#ref(image.png,300x200,説明)` | `<img src="ページ名_attachment_image.png" alt="説明" width="300" height="200">` | サイズ+altテキスト |
| `&ref(image.png,300x200,説明);` | `<img src="ページ名_attachment_image.png" alt="説明" width="300" height="200">` | インライン・サイズ指定 |

**サポートされるサイズ形式:**
- `300x200` - 幅×高さ（ピクセル）
- `300x` - 幅のみ（ピクセル）
- `x200` - 高さのみ（ピクセル）
- `300w` - 幅（ピクセル）
- `200h` - 高さ（ピクセル）
- `50%` または `50.5%` - パーセント指定

##### 5.5.1.3 パラメータの扱い

`#ref`と`&ref`の両方で複数のパラメータを指定できます。以下のパラメータは変換時にフィルタされます：

**フィルタされるキーワード:**
- `left`, `center`, `right` - 配置指定
- `wrap`, `nowrap`, `around` - テキスト回り込み指定
- `nolink`, `noicon`, `noimg`, `zoom` - 表示オプション

**テキストパラメータの結合:**
複数のテキストパラメータはカンマで結合されてaltテキストになります。

**例:**
```
入力: #ref(image.png,left,300x200,図1,システム構成)
出力: <img src="ページ名_attachment_image.png" alt="図1,システム構成" width="300" height="200">

入力: &ref(image.png,center,50%,テスト);
出力: <img src="ページ名_attachment_image.png" alt="テスト" style="width: 50%">
```

#### 5.5.2 非画像ファイル参照

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `#ref(document.pdf)` | `[document.pdf](ページ名_attachment_document.pdf)` | ファイルリンク |
| `#ref(spec.xlsx,仕様書)` | `[仕様書](ページ名_attachment_spec.xlsx)` | リンクテキスト指定 |
| `#ref(spec.xlsx,noicon,仕様書,最新版)` | `[仕様書,最新版](ページ名_attachment_spec.xlsx)` | パラメータ付き |
| `&ref(document.pdf);` | `[document.pdf](ページ名_attachment_document.pdf)` | ファイルリンク |

**注:** 非画像ファイルの場合、サイズ指定パラメータは無視されます。

### 5.6 引用

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `>引用文` | `> 引用文` | |
| `>>引用文` | `> > 引用文` | ネスト引用 |

### 5.7 水平線

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `----` | `---` | 水平線（4つ以上のハイフン） |
| `#hr` | `---` | 水平線（プラグイン記法） |

### 5.8 テーブル

#### 5.8.1 基本テーブル

| PukiWiki | Markdown |
|----------|----------|
| `|セル1|セル2|` | `| セル1 | セル2 |` |

**例:**
```
入力:
|ヘッダ1|ヘッダ2|h
|データ1|データ2|

出力:
| ヘッダ1 | ヘッダ2 |
| --- | --- |
| データ1 | データ2 |
```

#### 5.8.2 テーブルヘッダ（`|h`）

PukiWikiの`|h`記法はMarkdownのヘッダー行として変換され、セパレーター行が自動挿入されます。

| PukiWiki | Markdown |
|----------|----------|
| `|列1|列2|h` | `| 列1 | 列2 |`<br>`| --- | --- |` |

#### 5.8.3 セル配置指定

セル内に`LEFT:`, `CENTER:`, `RIGHT:`を記述することで、カラムの配置を指定できます。

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `|LEFT:左寄せ|` | `| 左寄せ |`<br>`| --- |` | デフォルト（省略可） |
| `|CENTER:中央|` | `| 中央 |`<br>`| :---: |` | 中央寄せ |
| `|RIGHT:右寄せ|` | `| 右寄せ |`<br>`| ---: |` | 右寄せ |

**注意事項:**
- 配置指定はカラムごとに最初に出現したものが適用されます
- `LEFT:`, `CENTER:`, `RIGHT:`の文字列自体はセル内容から削除されます

**例:**
```
入力:
|LEFT:名前|CENTER:年齢|RIGHT:金額|h
|太郎|25|1000|
|花子|30|2000|

出力:
| 名前 | 年齢 | 金額 |
| --- | :---: | ---: |
| 太郎 | 25 | 1000 |
| 花子 | 30 | 2000 |
```

#### 5.8.4 個別ヘッダーセル（`~`）

セルの先頭に`~`を付けると、そのセルが太字に変換されます。

| PukiWiki | Markdown |
|----------|----------|
| `|~見出し|通常|` | `| **見出し** | 通常 |` |

`~`と配置指定は組み合わせることができます：

```
入力:
|CENTER:~名前|RIGHT:~年齢|h
|太郎|25|

出力:
| **名前** | **年齢** |
| :---: | ---: |
| 太郎 | 25 |
```

#### 5.8.5 無視される記法

以下のPukiWiki記法は、Markdownで表現できないため無視されます：

- `|f` - フッター行（変換時にスキップ）
- `|c` - カラム幅設定行（変換時にスキップ）
- `>` - 横方向セル結合（colspan）
- `~` 単独 - 縦方向セル結合（rowspan）
- `BGCOLOR(色):` - 背景色指定
- `COLOR(色):` - 文字色指定
- `SIZE(数値):` - フォントサイズ指定
- `BOLD:` - 太字指定（既存のインライン変換`''text''`で対応可能）

これらの機能が必要な場合は、HTMLタグを直接使用してください。

### 5.9 プラグイン記法

その他のプラグイン記法（`#contents`、`#ls`、`#include`、`#comment`、`#vote`、`#tracker`、`#calendar`など）はそのまま残します。

---

## 6. 添付ファイル処理仕様

### 6.1 検出処理

1. `attach/`フォルダ内のファイルを走査
2. ファイル名のプレフィックス(`_`の前)がエンコードされたページ名と一致するものを抽出
3. 該当ページの添付ファイルとして処理

### 6.2 変換処理

1. **ファイル名デコード**: エンコードされたページ名部分をデコード
2. **ファイル名生成**: `<ページ名>_attachment_<元のファイル名>`
3. **ファイルコピー**: 対応するMarkdownファイルと同じディレクトリにコピー

### 6.3 Markdown内の参照更新

1. `#ref(ファイル名)`などの添付ファイル参照を検出
2. 新しいファイル名に置き換え
3. 相対パスが正しく解決されることを確認

---

## 7. エラーハンドリング仕様

### 7.1 ログ出力

#### 7.1.1 ログ形式

各ファイルの処理結果を以下の形式で出力する:

```
[<STATUS>] <元のファイルパス> → <出力パス> (<詳細情報>)
```

#### 7.1.2 ステータス

| ステータス | 意味 | 使用場面 |
|----------|------|--------|
| SUCCESS | 処理成功 | ページ変換成功、添付ファイルコピー成功 |
| ERROR | 処理失敗 | デコード失敗、変換エラー、ファイル操作エラー |

**注**: 処理対象外のファイル(`:config`ファイル、`.log`ファイル、アンダースコアを含まないファイルなど)は、ファイル収集段階で除外されるため、ログには出力されません。

#### 7.1.3 出力例

```
Starting conversion...
Wiki folder: /path/to/pukiwiki/wiki
Attach folder: /path/to/pukiwiki/attach
Output folder: /path/to/output

Wiki files: 45
Attachment files: 12

[SUCCESS] wiki/A4D7A4EDA4B8A4A7A4AFA4C8.txt → output/プロジェクト.md (converted)
[SUCCESS] wiki/A4D7A4EDA4B8A4A7A4AFA4C82FA4BFA4B9.txt → output/プロジェクト/タスク.md (converted)
[SUCCESS] attach/A4D7A4EDA4B8A4A7A4AFA4C8_A5C0A5A4A5A2A5B0A5E9A5E02E706E67 → output/プロジェクト_attachment_ダイアグラム.png (attachment copied)
[ERROR] wiki/XYZ123.txt → (failed to decode filename)
[ERROR] wiki/A4C6A4B9A4C8.txt → output/テスト.md (encoding conversion failed)

Conversion completed.
```

**注**: 処理対象ファイルの件数は、`:config`ファイルや`.log`ファイルなどを除外した後の数値です。

### 7.2 サマリー出力

処理完了時に以下の統計情報を表示:

```
Completed:
- Pages converted: 45
- Page errors: 2
- Attachments copied: 12
- Attachment errors: 1

Output folder: /path/to/output
```

#### 7.2.1 統計項目

| 項目 | 説明 |
|------|------|
| Pages converted | 正常に変換されたページ数 |
| Page errors | 変換に失敗したページ数 |
| Attachments copied | 正常にコピーされた添付ファイル数 |
| Attachment errors | コピーに失敗した添付ファイル数 |

**注**: スキップされたファイル(`:config`ファイル、`.log`ファイルなど)は統計に含まれません。これらは処理対象として収集されないため、カウントされません。

---

## 8. 制限事項

### 8.1 既知の制限

1. **ファイル名にスペースを含むページ**: 変換に失敗する可能性がある
2. **カスタムプラグイン**: Markdownに変換できず、コメント化または削除される
3. **InterWiki**: 他のWikiへのリンクは通常のURLリンクとして扱う
4. **ページの別名機能**: PukiWikiのページ別名は未サポート

### 8.2 サポート対象外

- PukiWiki固有の動的機能(投票、トラッカーなど)
- スキン・テーマ情報
- ユーザー管理・権限設定
- プラグインの動的な出力

### 8.3 環境要件

- **Node.js**: v18.0.0以上
- **メモリ**: 最低512MB(大規模なwikiの場合はそれ以上)
- **ディスク**: 入力データの2倍以上の空き容量を推奨

## 9. 参考資料

### 9.1 外部リンク
- [PukiWiki公式](https://pukiwiki.sourceforge.io/)
- [PukiWiki整形ルール](https://pukiwiki.sourceforge.io/?FormattingRules)
- [GitHub Flavored Markdown仕様](https://github.github.com/gfm/)

### 9.2 参考記事
- https://qiita.com/tatsurou313/items/95374e14f73c4f2d3b06
- https://qiita.com/tokumoto/items/5e621b5fadb028566c3a
- https://qiita.com/yuki-takei/items/152e20f4421333ae8fd9
