# PukiWiki to Markdown 変換ツール 仕様書

## 1. 概要

### 1.1 目的
PukiWikiのwikiページデータおよび添付ファイルをMarkdown形式に変換し、ファイルシステムに出力する。

### 1.2 スコープ
- **対象**: PukiWikiのwikiフォルダ(ページデータ)とattachフォルダ(添付ファイル)
- **出力**: Markdownファイル、添付ファイル、ディレクトリ構造

---

## 2. CLI仕様

### 2.1 コマンド形式
```bash
pukiwiki-to-md --wiki <wikiフォルダ> --attach <attachフォルダ> --output <出力フォルダ> [オプション]
```

### 2.2 必須オプション

| オプション | 短縮形 | 説明 | 例 |
|----------|-------|------|-----|
| `--wiki` | `-w` | PukiWikiのwikiフォルダパス | `./pukiwiki/wiki` |
| `--attach` | `-a` | PukiWikiのattachフォルダパス | `./pukiwiki/attach` |
| `--output` | `-o` | 出力先フォルダパス | `./output` |

### 2.3 オプション引数

| オプション | 短縮形 | デフォルト値 | 説明 |
|----------|-------|------------|------|
| `--encoding` | `-e` | `utf-8` | 入力ファイルの文字エンコーディング |
| `--exclude-plugins` | `-x` | (空) | カスタムブロックプラグインのカンマ区切りリスト |
| `--help` | `-h` | - | ヘルプを表示 |
| `--version` | `-v` | - | バージョンを表示 |

### 2.4 実行例

```bash
# 基本的な使用方法(UTF-8)
pukiwiki-to-md -w ./pukiwiki/wiki -a ./pukiwiki/attach -o ./output

# EUC-JPエンコーディングのPukiWikiを変換
pukiwiki-to-md -w ./wiki -a ./attach -o ./output --encoding euc-jp

# カスタムプラグインを除外
pukiwiki-to-md -w ./wiki -a ./attach -o ./output -x "myplugin,customplugin"

# ヘルプ表示
pukiwiki-to-md --help
```

### 2.5 終了コード

| コード | 説明 |
|-------|------|
| `0` | 正常終了 |
| `1` | エラー終了(ディレクトリが存在しない、権限エラーなど) |

---

## 3. 入力仕様

### 3.1 PukiWiki wikiフォルダ構造

```
wiki/
├── A4C6A4ACA4EFA4B0.txt         # エンコードされたファイル名
├── B5ECBDB1.txt
├── 3AConfig2FPlugin.txt         # :config で始まるファイル(除外対象)
├── index.html                   # ディレクトリインデックス(除外対象)
├── .htaccess                    # アクセス制御(除外対象)
└── ...
```

#### 3.1.1 ファイル名エンコーディング
- **形式**: URLエンコード(パーセント記号なし)
- **エンコード方式**: 2文字ごとに`%`を挿入してURLデコード
- **例**:
  - エンコード済み: `A4C6A4ACA4EFA4B0`
  - デコード処理: `%A4%C6%A4%AC%A4%EF%A4%B0`
  - 結果: `てがわぐ` (EUC-JPバイト列をデコード)

#### 3.1.2 ファイル内容
- **拡張子**: `.txt`
- **文字エンコーディング**: UTF-8またはEUC-JP(--encodingオプションで指定)
- **フォーマット**: PukiWiki記法

#### 3.1.3 処理対象の判定条件

wikiページとして処理するファイルは以下の条件を**すべて満たす**もの:

1. 拡張子が `.txt`
2. デコード後のページ名が特定のシステムページではない

この条件により、以下のファイルは自動的に除外される:
- `:config`: 設定ページ
- `:config/*`: 設定ページ配下のすべてのページ（例: `:config/Plugin`）
- `:RenameLog`: ページ名変更履歴
- `index.html`: ディレクトリインデックス(拡張子が`.txt`でない)
- `.htaccess`: アクセス制御ファイル(拡張子が`.txt`でない)

**注意事項:**
- ページ名のチェックは、ファイル名をデコードした後に行われます
- これにより、EUC-JPとUTF-8の両方のエンコーディングで正しく動作します
- ユーザーが作成した `:` で始まるページ（例: `:userpage1`）は除外されず、通常通り変換されます

### 3.2 PukiWiki attachフォルダ構造

```
attach/
├── A4C6A4ACA4EFA4B0_A5A4A5E1A5BCA5B82E706E67       # <エンコードされたページ名>_<エンコードされたファイル名>
├── A4C6A4ACA4EFA4B0_A5A4A5E1A5BCA5B82E706E67.log   # 添付ファイルのメタデータ(除外対象)
├── A4C6A4ACA4EFA4B0_A5C9A5ADA5E5A5E1A5F3A5C82E706466
├── index.html                                     # ディレクトリインデックス(除外対象)
├── .htaccess                                      # アクセス制御(除外対象)
└── ...
```

#### 3.2.1 ファイル命名規則
- **形式**: `<エンコードされたページ名>_<エンコードされた添付ファイル名>`
- **エンコード方式**: ページ名とファイル名(拡張子含む)の両方がURLエンコード(パーセント記号なし)
- **区切り文字**: `_`(アンダースコア、エンコードされていない)
- **例**:
  - エンコード済み: `A4C6A4B9A4C8_A5B9A5AFA5EAA5FCA5F3A5B7A5E7A5C3A5C82E706E67`
  - デコード後: ページ名 `テスト` + ファイル名 `スクリーンショット.png` (`.png` = `2E706E67`)

#### 3.2.2 処理対象の判定条件

添付ファイルとして処理するファイルは以下の条件を**すべて満たす**もの:

1. ファイル名が `<文字列>_<文字列>` の形式(アンダースコアを含む)
2. 拡張子が `.log` ではない

この条件により、以下のファイルは自動的に除外される:
- `.log`ファイル: 添付ファイルのメタデータ
- `index.html`: ディレクトリインデックス(アンダースコアを含まない)
- `.htaccess`: アクセス制御ファイル(アンダースコアを含まない)

---

## 4. 出力仕様

### 4.1 ディレクトリ構造

PukiWikiのページ名に含まれる`/`(スラッシュ)をディレクトリ階層として解釈する。

#### 入力例
```
wiki/
├── A4D7A4EDA4B8A4A7A4AFA4C8.txt           # プロジェクト
├── A4D7A4EDA4B8A4A7A4AFA4C82FA4BFA4B9.txt # プロジェクト/タスク
└── ...
```

#### 出力例
```
output/
├── プロジェクト.md
├── プロジェクト/
│   └── タスク.md
└── ...
```

### 4.2 Markdownファイル仕様

#### 4.2.1 ファイル名
- **形式**: `<デコードされたページ名>.md`
- **文字エンコーディング**: UTF-8
- **例**: `プロジェクト概要.md`

#### 4.2.2 ファイル内容
- **フォーマット**: Markdown(GitHub Flavored Markdown準拠)
- **文字エンコーディング**: UTF-8
- **改行コード**: LF(`\n`)

### 4.3 添付ファイル仕様

#### 4.3.1 配置場所
対応するMarkdownファイルと同じディレクトリ

#### 4.3.2 ファイル命名規則
```
<ページ名>_attachment_<元のファイル名>
```

#### 4.3.3 例

| 元のPukiWiki添付ファイル | デコード後 | 出力ファイル名 |
|---------------------|---------|--------------|
| `A4C6A4B9A4C8_A5A4A5E1A5BCA5B82E706E67` | ページ名: `テスト`<br>ファイル名: `イメージ.png` | `テスト_attachment_イメージ.png` |
| `A4D7A4EDA4B8A4A7A4AFA4C8_A5C9A5ADA5E5A5E1A5F3A5C82E706466` | ページ名: `プロジェクト`<br>ファイル名: `ドキュメント.pdf` | `プロジェクト_attachment_ドキュメント.pdf` |

---

## 5. 変換仕様

### 5.1 見出し

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `*見出し1` | `# 見出し1` | レベル1見出し |
| `**見出し2` | `## 見出し2` | レベル2見出し |
| `***見出し3` | `### 見出し3` | レベル3見出し |

**アンカーIDの削除:**
PukiWikiでは見出しに自動生成されるアンカーID（例: `[#qb249ac2]`）が付与されますが、変換時に削除されます。

| PukiWiki | Markdown |
|----------|----------|
| `*見出し [#abc123]` | `# 見出し` |
| `**見出し [#xyz789]` | `## 見出し` |

**例:**
```
入力: *はじめに
出力: # はじめに

入力: *FrontPage [#qb249ac2]
出力: # FrontPage
```

### 5.2 リスト

#### 5.2.1 箇条書きリスト

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `-項目` | `- 項目` | レベル1 |
| `--項目` | `    - 項目` | レベル2(インデント4スペース) |
| `---項目` | `        - 項目` | レベル3(インデント8スペース) |

**例:**
```
入力:
-項目1
--項目1-1
---項目1-1-1
-項目2

出力:
- 項目1
    - 項目1-1
        - 項目1-1-1
- 項目2
```

#### 5.2.2 番号付きリスト

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `+項目` | `1. 項目` | レベル1 |
| `++項目` | `    1. 項目` | レベル2(インデント4スペース) |
| `+++項目` | `        1. 項目` | レベル3(インデント8スペース) |

### 5.3 テキスト装飾

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `''強調''` | `**強調**` | 太字 |
| `'''イタリック'''` | `*イタリック*` | 斜体 |
| `%%取り消し%%` | `~~取り消し~~` | 取り消し線 |
| `%%%下線%%%` | `<u>下線</u>` | 下線 |
| `&br;` または `&br();` | `<br>` | 改行（インライン） |
| `テキスト~` | `テキスト<br>` | 行末改行 |
| `&size(20){テキスト};` | `<span style="font-size: 20px">テキスト</span>` | 文字サイズ指定 |
| `&color(red){テキスト};` | `<span style="color: red">テキスト</span>` | 文字色指定 |
| `&color(red,yellow){テキスト};` | `<span style="color: red; background-color: yellow">テキスト</span>` | 文字色と背景色指定 |

**注意事項:**
- 行末改行（`~`）は行末にある場合のみ変換されます
- 行末にスペースやタブがある場合は変換されません
- 下線はHTMLの`<u>`タグに変換されます（Markdownに標準の下線構文はありません）
- 文字サイズはピクセル単位(px)で指定します
- 文字色は色名（`red`, `blue`など）または16進数（`#FF0000`, `#F00`など）で指定できます
- 背景色は省略可能です
- `&size`と`&color`はHTMLの`<span>`タグに変換されるため、Markdownビューアーによっては表示されない場合があります

**例:**
```
入力:
テキスト1~
テキスト2~
''太字''と'''イタリック'''と%%取り消し%%と%%%下線%%%
&size(20){大きい文字};と&color(red){赤い文字};

出力:
テキスト1<br>
テキスト2<br>
**太字**と*イタリック*と~~取り消し~~と<u>下線</u>
<span style="font-size: 20px">大きい文字</span>と<span style="color: red">赤い文字</span>
```

### 5.4 リンク

#### 5.4.1 内部リンク

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `[[ページ名]]` | `[ページ名](相対パス)` | 相対パスで解決 |
| `[[テキスト>ページ名]]` | `[テキスト](相対パス)` | リンクテキスト指定 |
| `[[カテゴリ/ページ]]` | `[カテゴリ/ページ](相対パス)` | 階層リンク |

**相対パス解決の例:**

同じディレクトリ内:
```
現在のページ: プロジェクト/タスク
リンク: [[プロジェクト/概要]]
出力: [プロジェクト/概要](概要.md)
```

ルートレベルから階層へ:
```
現在のページ: トップページ
リンク: [[プロジェクト/タスク]]
出力: [プロジェクト/タスク](プロジェクト/タスク.md)
```

階層からルートレベルへ:
```
現在のページ: プロジェクト/タスク
リンク: [[トップページ]]
出力: [トップページ](../トップページ.md)
```

異なる階層間（兄弟ディレクトリ）:
```
現在のページ: プロジェクトA/タスク
リンク: [[プロジェクトB/概要]]
出力: [プロジェクトB/概要](../プロジェクトB/概要.md)
```

#### 5.4.2 外部リンク

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `[[テキスト:https://example.com]]` | `[テキスト](https://example.com)` | |
| `https://example.com` | `https://example.com` | URL直接記述 |

### 5.5 画像・添付ファイル

ファイルの拡張子によって、画像表示（`![]()`またはHTMLの`<img>`タグ）またはファイルリンク（`[]()`）に変換されます。

**画像ファイル拡張子**: `.png`, `.jpg`, `.jpeg`, `.gif`, `.bmp`, `.svg`, `.webp`

#### 5.5.1 画像ファイル参照

##### 5.5.1.1 基本形式（サイズ指定なし）

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `#ref(image.png)` | `![](ページ名_attachment_image.png)` | 画像表示 |
| `#ref(image.png,テキスト)` | `![テキスト](ページ名_attachment_image.png)` | altテキスト指定 |
| `&ref(icon.png);` | `![](ページ名_attachment_icon.png)` | 画像表示（インライン） |
| `&ref(icon.png,アイコン);` | `![アイコン](ページ名_attachment_icon.png)` | altテキスト指定（インライン） |

**例:**
```
ページ名: プロジェクト概要
入力: #ref(screenshot.png)
出力: ![](概要_attachment_screenshot.png)
```

##### 5.5.1.2 サイズ指定あり（HTMLタグ使用）

サイズ指定がある場合、HTMLの`<img>`タグに変換されます。`#ref`と`&ref`の両方でサポートされています。

| PukiWiki | HTML | 備考 |
|----------|------|------|
| `#ref(image.png,300x200)` | `<img src="ページ名_attachment_image.png" width="300" height="200">` | 幅×高さ指定 |
| `#ref(image.png,300x)` | `<img src="ページ名_attachment_image.png" width="300">` | 幅のみ指定 |
| `#ref(image.png,x200)` | `<img src="ページ名_attachment_image.png" height="200">` | 高さのみ指定 |
| `#ref(image.png,300w)` | `<img src="ページ名_attachment_image.png" width="300">` | 幅指定（ピクセル） |
| `#ref(image.png,200h)` | `<img src="ページ名_attachment_image.png" height="200">` | 高さ指定（ピクセル） |
| `#ref(image.png,50%)` | `<img src="ページ名_attachment_image.png" style="width: 50%">` | パーセント指定 |
| `#ref(image.png,300x200,説明)` | `<img src="ページ名_attachment_image.png" alt="説明" width="300" height="200">` | サイズ+altテキスト |
| `&ref(image.png,300x200,説明);` | `<img src="ページ名_attachment_image.png" alt="説明" width="300" height="200">` | インライン・サイズ指定 |

**サポートされるサイズ形式:**
- `300x200` - 幅×高さ（ピクセル）
- `300x` - 幅のみ（ピクセル）
- `x200` - 高さのみ（ピクセル）
- `300w` - 幅（ピクセル）
- `200h` - 高さ（ピクセル）
- `50%` または `50.5%` - パーセント指定

##### 5.5.1.3 パラメータの扱い

`#ref`と`&ref`の両方で複数のパラメータを指定できます。以下のパラメータは変換時にフィルタされます：

**フィルタされるキーワード:**
- `left`, `center`, `right` - 配置指定
- `wrap`, `nowrap`, `around` - テキスト回り込み指定
- `nolink`, `noicon`, `noimg`, `zoom` - 表示オプション

**テキストパラメータの結合:**
複数のテキストパラメータはカンマで結合されてaltテキストになります。

**例:**
```
入力: #ref(image.png,left,300x200,図1,システム構成)
出力: <img src="ページ名_attachment_image.png" alt="図1,システム構成" width="300" height="200">

入力: &ref(image.png,center,50%,テスト);
出力: <img src="ページ名_attachment_image.png" alt="テスト" style="width: 50%">
```

#### 5.5.2 非画像ファイル参照

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `#ref(document.pdf)` | `[document.pdf](ページ名_attachment_document.pdf)` | ファイルリンク |
| `#ref(spec.xlsx,仕様書)` | `[仕様書](ページ名_attachment_spec.xlsx)` | リンクテキスト指定 |
| `#ref(spec.xlsx,noicon,仕様書,最新版)` | `[仕様書,最新版](ページ名_attachment_spec.xlsx)` | パラメータ付き |
| `&ref(document.pdf);` | `[document.pdf](ページ名_attachment_document.pdf)` | ファイルリンク |

**注:** 非画像ファイルの場合、サイズ指定パラメータは無視されます。

### 5.6 引用

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `>引用文` | `> 引用文` | |
| `>>引用文` | `> > 引用文` | ネスト引用 |

### 5.7 水平線

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `----` | `---` | 水平線（4つ以上のハイフン） |
| `#hr` または `#hr()` | `---` | 水平線（プラグイン記法） |

### 5.8 改行

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `#br` または `#br()` | `<br>` | 改行（プラグイン記法） |

**注意事項:**
- `#br` または `#br()` の前に空白やタブがある場合は整形済みテキストとして扱われます
- 行末の空白は変換前に削除されます

**例:**
```
入力:
テキスト1
#br
#br()
テキスト2

出力:
テキスト1
<br>
<br>
テキスト2
```

### 5.9 テーブル

#### 5.9.1 テーブル形式

PukiWikiのテーブルは、すべてMarkdown形式のテーブルとして出力されます。

**`|h`（ヘッダー行マーカー）がある場合:**
- その行をヘッダー行として使用
- セパレーター行が自動挿入される
- 列の配置指定（LEFT/CENTER/RIGHT）がサポートされる

**`|h`がない場合:**
- 空のヘッダー行が自動的に追加される
- その後にセパレーター行が挿入される
- すべてのデータ行がMarkdownテーブルのデータ行として出力される

**重要:** セル内のPukiWiki記法（リンク、装飾など）は、Markdownテーブル内でも正しく変換されます。

**ヘッダーありの例:**
```
入力:
|ヘッダ1|ヘッダ2|h
|データ1|データ2|

出力:
| ヘッダ1 | ヘッダ2 |
| --- | --- |
| データ1 | データ2 |
```

**ヘッダーなしの例（空ヘッダーが自動追加）:**
```
入力:
|データ1|データ2|
|データ3|データ4|

出力:
|   |   |
| --- | --- |
| データ1 | データ2 |
| データ3 | データ4 |
```

**セル内にリンクを含む例:**
```
入力:
|[[トップページ]]|説明|
|[[ヘルプ]]|ヘルプページ|

出力:
|   |   |
| --- | --- |
| [トップページ](トップページ.md) | 説明 |
| [ヘルプ](ヘルプ.md) | ヘルプページ |
```

#### 5.9.2 テーブルヘッダ（`|h`）

PukiWikiの`|h`記法はMarkdownのヘッダー行として変換され、セパレーター行が自動挿入されます。

| PukiWiki | Markdown |
|----------|----------|
| `|列1|列2|h` | `| 列1 | 列2 |`<br>`| --- | --- |` |

#### 5.9.3 セル配置指定

セル内に`LEFT:`, `CENTER:`, `RIGHT:`を記述することで、カラムの配置を指定できます。

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `|LEFT:左寄せ|` | `| 左寄せ |`<br>`| --- |` | デフォルト（省略可） |
| `|CENTER:中央|` | `| 中央 |`<br>`| :---: |` | 中央寄せ |
| `|RIGHT:右寄せ|` | `| 右寄せ |`<br>`| ---: |` | 右寄せ |

**注意事項:**
- 配置指定はカラムごとに最初に出現したものが適用されます
- `LEFT:`, `CENTER:`, `RIGHT:`の文字列自体はセル内容から削除されます

**例:**
```
入力:
|LEFT:名前|CENTER:年齢|RIGHT:金額|h
|太郎|25|1000|
|花子|30|2000|

出力:
| 名前 | 年齢 | 金額 |
| --- | :---: | ---: |
| 太郎 | 25 | 1000 |
| 花子 | 30 | 2000 |
```

#### 5.9.4 個別ヘッダーセル（`~`）

セルの先頭に`~`を付けると、そのセルが太字（`**テキスト**`）に変換されます。

**例:**
```
入力:
|~見出し|通常|

出力:
|   |   |
| --- | --- |
| **見出し** | 通常 |
```

**複数のセルに適用:**
```
入力:
|~項目|値|
|~名前|田中|
|~年齢|25|

出力:
|   |   |
| --- | --- |
| **項目** | 値 |
| **名前** | 田中 |
| **年齢** | 25 |
```

**`|h`と組み合わせた例:**
```
入力:
|~見出し|通常|h

出力:
| **見出し** | 通常 |
| --- | --- |
```

**配置指定との組み合わせ:**
```
入力:
|CENTER:~名前|RIGHT:~年齢|h
|太郎|25|

出力:
| **名前** | **年齢** |
| :---: | ---: |
| 太郎 | 25 |
```

#### 5.9.5 特殊行マーカー

**`|f` - フッター行:**
- フッター行マーカー `|f` は無視され、通常の行として出力されます
- 例: `|合計|1000|f` → 通常の行として変換

**`|c` - カラム幅設定行:**
- カラム幅設定行は出力時にスキップされます（Markdown/HTMLともに表現不可）
- 例: `|100|200|c` → 出力されない

#### 5.9.6 セル装飾

テーブルセル内で以下の装飾プレフィックスを使用できます。

**対応する装飾:**

| PukiWiki記法 | 説明 | 出力 |
|-------------|------|------|
| `BOLD:テキスト` | 太字 | `**テキスト**` |
| `SIZE(数値):テキスト` | フォントサイズ（px） | `<span style="font-size: 数値px">テキスト</span>` |
| `COLOR(色):テキスト` | 文字色 | `<span style="color: 色">テキスト</span>` |
| `BGCOLOR(色):テキスト` | 背景色（コメントとして保存） | `テキスト <!-- BGCOLOR(色) -->` |

**処理順序:**

セル内のプレフィックスは以下の順序で処理されます：

1. `LEFT:` / `CENTER:` / `RIGHT:` （配置指定 - 最初に処理）
2. `BOLD:`
3. `SIZE(数値):`
4. `COLOR(色):`
5. `BGCOLOR(色):`
6. `~` （個別ヘッダーセル）

**基本的な装飾の例:**
```
入力:
|BOLD:太字|SIZE(20):大きい|COLOR(red):赤|h

出力:
| **太字** | <span style="font-size: 20px">大きい</span> | <span style="color: red">赤</span> |
| --- | --- | --- |
```

**ヘッダーなしテーブルでの装飾:**
```
入力:
|BOLD:太字|SIZE(20):大きい|COLOR(red):赤|

出力:
|   |   |   |
| --- | --- | --- |
| **太字** | <span style="font-size: 20px">大きい</span> | <span style="color: red">赤</span> |
```

**複数の装飾を組み合わせた例:**
```
入力:
|BOLD:SIZE(20):COLOR(red):BGCOLOR(yellow):全部|通常|h

出力:
| <span style="font-size: 20px; color: red">**全部**</span> <!-- BGCOLOR(yellow) --> | 通常 |
| --- | --- |
```

**配置指定との組み合わせ:**
```
入力:
|LEFT:BOLD:名前|RIGHT:SIZE(20):大きい|h

出力:
| **名前** | <span style="font-size: 20px">大きい</span> |
| --- | ---: |
```

**注意事項:**
- `BGCOLOR`はMarkdownテーブルでセル全体の背景色を指定できないため、HTMLコメントとして保存されます
- HTMLテーブルに変換するとセル内のMarkdown記法（リンク、太字など）が使用できなくなるため、変換は行いません
- 必要に応じて、手動でHTMLテーブルに書き換えることができます
- 色指定は CSS の色名（`red`, `blue` など）や16進数カラーコード（`#FF0000` など）が使用可能です
- `BOLD:` と個別ヘッダーセル `~` は両方とも太字化しますが、併用も可能です
- 複数の装飾を組み合わせる場合、上記の処理順序に従って記述することを推奨します
- セル内のPukiWiki記法（リンク、太字など）は正しく変換されます

#### 5.9.7 無視される記法

以下のPukiWiki記法は、Markdownで表現できないため無視されます：

- `>` - 横方向セル結合（colspan）
- `~` 単独 - 縦方向セル結合（rowspan）

これらの機能が必要な場合は、HTMLタグを直接使用してください。

### 5.10 整形済みテキスト

行頭が半角空白（スペースまたはタブ）で始まる行は整形済みテキストとして扱われ、Markdownのフェンスコードブロック（` ``` `）に変換されます。

| PukiWiki | Markdown |
|----------|----------|
| ` 整形済みテキスト` | ` ``` `<br>`整形済みテキスト`<br>` ``` ` |

連続する整形済みテキスト行は1つのコードブロックにまとめられます。

**例:**
```
入力:
 整形済みテキスト1
 整形済みテキスト2

出力:
```
整形済みテキスト1
整形済みテキスト2
```
```

**注意事項:**
- 行頭の空白は**1つのみ削除**されます（相対的なインデントは保持されます）
- 整形済みテキスト内ではPukiWikiの記法は無効化されます（そのまま表示される）
- 空白のみの行は整形済みテキストとして扱われません
- タブで始まる行も整形済みテキストとして扱われます（タブ1つが削除されます）
- 行頭に空白がある `----` や `#hr` / `#hr()` は整形済みテキストとして扱われます（水平線にはなりません）

**インデントの保持:**
```
入力:
  function() {
    return 42;
  }

出力:
```
 function() {
   return 42;
 }
```
```

各行の先頭空白を1つずつ削除するため、相対的なインデントが保持されます。

### 5.11 ブロックプラグインのHTMLコメント化

以下のPukiWikiブロックプラグインは、静的Markdownでは機能しないため、HTMLコメントとして保存されます（合計46個）：

#### 5.11.1 システムディレクティブ (4個)

| PukiWiki | 変換後 | 備考 |
|----------|--------|------|
| `#author("timestamp","user_id","name")` | `<!-- #author(...) -->` | ページメタデータ（PukiWikiが自動生成） |
| `#freeze` | `<!-- #freeze -->` | ページ凍結設定（編集制御） |
| `#nofollow` | `<!-- #nofollow -->` | 検索エンジンへのヒント |
| `#norelated` | `<!-- #norelated -->` | 関連ページ表示の抑制 |

#### 5.11.2 コンテンツインクルード・表示 (4個)

| PukiWiki | 変換後 | 備考 |
|----------|--------|------|
| `#amazon` | `<!-- #amazon -->` | Amazon商品情報表示 |
| `#aname` | `<!-- #aname -->` | アンカー定義 |
| `#include(ページ名)` | HTMLコメント + リンク | 他ページのインクルード（特別処理） |
| `#includesubmenu` | `<!-- #includesubmenu -->` | サブメニューのインクルード |

**`#include` プラグインの特別処理:**

`#include` プラグインは、HTMLコメントとリンクの組み合わせに変換されます：

```
入力:
#include(共通ヘッダー)

出力:
<!-- #include(共通ヘッダー) -->
[共通ヘッダー](共通ヘッダー.md)
```

パラメータがある場合もコメントに保存されます：

```
入力:
#include(ページ名,notitle)

出力:
<!-- #include(ページ名,notitle) -->
[ページ名](ページ名.md)
```

階層ページの場合は相対パスが自動的に計算されます：

```
現在のページ: プロジェクト/タスク
入力: #include(プロジェクト/共通部分)

出力:
<!-- #include(プロジェクト/共通部分) -->
[プロジェクト/共通部分](共通部分.md)
```

この変換により、元の構文を保持しつつ、インクルード先のページへのナビゲーションが可能になります。

#### 5.11.3 動的機能・フォーム (10個)

| PukiWiki | 変換後 | 備考 |
|----------|--------|------|
| `#article` | `<!-- #article -->` | 記事投稿フォーム |
| `#attach` | `<!-- #attach -->` | ファイルアップロードフォーム |
| `#comment` | `<!-- #comment -->` | コメント投稿フォーム |
| `#contents` | `<!-- #contents -->` | 目次自動生成 |
| `#counter` | `<!-- #counter -->` | アクセスカウンター |
| `#insert` | `<!-- #insert -->` | 挿入フォーム |
| `#lookup` | `<!-- #lookup -->` | 辞書検索 |
| `#navi` | `<!-- #navi -->` | ナビゲーション |
| `#newpage` | `<!-- #newpage -->` | 新規ページ作成フォーム |
| `#pcomment` | `<!-- #pcomment -->` | ページコメントフォーム |

#### 5.11.4 リスト・ナビゲーション (10個)

| PukiWiki | 変換後 | 備考 |
|----------|--------|------|
| `#back` | `<!-- #back -->` | 戻るリンク |
| `#ls` | `<!-- #ls -->` | 子ページ一覧 |
| `#ls2` | `<!-- #ls2 -->` | 子ページ一覧（拡張版） |
| `#menu` | `<!-- #menu -->` | メニュー表示 |
| `#online` | `<!-- #online -->` | オンラインユーザー表示 |
| `#popular` | `<!-- #popular -->` | 人気ページランキング |
| `#recent` | `<!-- #recent -->` | 最近の更新表示 |
| `#related` | `<!-- #related -->` | 関連ページ表示 |
| `#search` | `<!-- #search -->` | 検索フォーム |
| `#topicpath` | `<!-- #topicpath -->` | トピックパス（パンくずリスト） |

#### 5.11.5 トラッカー・課題管理 (4個)

| PukiWiki | 変換後 |
|----------|--------|
| `#bugtrack` | `<!-- #bugtrack -->` |
| `#bugtrack_list` | `<!-- #bugtrack_list -->` |
| `#tracker` | `<!-- #tracker -->` |
| `#tracker_list` | `<!-- #tracker_list -->` |

#### 5.11.6 カレンダー (5個)

| PukiWiki | 変換後 |
|----------|--------|
| `#calendar` | `<!-- #calendar -->` |
| `#calendar2` | `<!-- #calendar2 -->` |
| `#calendar_edit` | `<!-- #calendar_edit -->` |
| `#calendar_read` | `<!-- #calendar_read -->` |
| `#calendar_viewer` | `<!-- #calendar_viewer -->` |

#### 5.11.7 ユーティリティ・その他 (9個)

| PukiWiki | 変換後 | 備考 |
|----------|--------|------|
| `#clear` | `<!-- #clear -->` | floatクリア（レイアウト制御） |
| `#memo` | `<!-- #memo -->` | メモ |
| `#paint` | `<!-- #paint -->` | お絵かきツール |
| `#random` | `<!-- #random -->` | ランダム表示 |
| `#server` | `<!-- #server -->` | サーバー情報 |
| `#setlinebreak` | `<!-- #setlinebreak -->` | 改行設定 |
| `#showrss` | `<!-- #showrss -->` | RSSフィード表示 |
| `#stationary` | `<!-- #stationary -->` | 雛形・テンプレート |
| `#version` | `<!-- #version -->` | バージョン表示 |
| `#versionlist` | `<!-- #versionlist -->` | バージョン一覧 |

#### 5.11.8 カスタムプラグインの除外

`--exclude-plugins` オプションを使用して、独自のプラグインを追加で除外できます：

```bash
pukiwiki-to-md -w ./wiki -a ./attach -o ./output -x "myplugin,customplugin"
```

この場合、`#myplugin` と `#customplugin` もHTMLコメント化されます。

**HTMLコメント化の理由:**
- これらはPukiWikiの動的機能やレイアウト制御です
- 静的Markdownファイルでは機能しませんが、参照のため保存されます
- 必要に応じて手動でMarkdown形式に書き直すことができます

**注意事項:**
- 行頭に空白やタブがある場合は整形済みテキストとして扱われ、変換されません
- パラメータも含めて保存されます

**例:**
```
入力:
#author("2025-03-14T11:18:07+09:00","default:user","User")
#freeze
*見出し
#contents(depth=2)
テキスト

出力:
<!-- #author("2025-03-14T11:18:07+09:00","default:user","User") -->
<!-- #freeze -->
# 見出し
<!-- #contents(depth=2) -->
テキスト
```

### 5.12 コメント

PukiWikiのコメント行はMarkdownのHTMLコメントに変換されます：

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `//コメント` | `<!-- コメント -->` | コメント行 |
| `// コメント` | `<!-- コメント -->` | 先頭スペースは削除 |

**注意事項:**
- 行頭に空白やタブがある場合は整形済みテキストとして扱われ、変換されません
- PukiWikiではコメント行は出力されませんが、Markdownでは情報保持のためHTMLコメントとして残します

**例:**
```
入力:
//これはコメントです
*見出し
// TODO: あとで修正
テキスト

出力:
<!-- これはコメントです -->
# 見出し
<!-- TODO: あとで修正 -->
テキスト
```

### 5.13 テキスト配置

PukiWikiのテキスト配置指定（`LEFT:`, `CENTER:`, `RIGHT:`）は、プレフィックスのみ削除されます：

| PukiWiki | 出力 | 備考 |
|----------|------|------|
| `LEFT:テキスト` | `テキスト` | プレフィックス削除 |
| `CENTER:テキスト` | `テキスト` | プレフィックス削除 |
| `RIGHT:テキスト` | `テキスト` | プレフィックス削除 |

**配置情報が保存されない理由:**
- Markdownには標準的なテキスト配置構文が存在しない
- HTMLタグ（`<div>`）を使用すると、内部のMarkdown構文が解釈されなくなる
- リンクや太字などのインライン要素が正しく変換されなくなる

**例:**
```
入力:
CENTER:中央揃えのテキスト
RIGHT:右寄せのテキスト
LEFT:左寄せのテキスト

出力:
中央揃えのテキスト
右寄せのテキスト
左寄せのテキスト
```

**インライン要素を含む例:**
```
入力:
CENTER:''太字''のテキスト
RIGHT:[[リンク]]

出力:
**太字**のテキスト
[リンク](リンク.md)
```

**注意事項:**
- 配置が必要な場合は、手動でHTMLを追加してください
- 行頭の配置指定のみ認識されます（行中の `CENTER:` などは変換されません）

### 5.14 行頭エスケープ

PukiWikiの行頭エスケープ（`~`）は、Markdownのバックスラッシュエスケープに変換されます：

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `~*見出し` | `\*見出し` | Markdown特殊文字をエスケープ |
| `~-リスト` | `\-リスト` | |
| `~>引用` | `\>引用` | |
| `~#見出し` | `\#見出し` | |
| `~&ref(image.png);` | `&ref(image.png);` | PukiWiki独自記法は`~`を削除 |
| `~//コメント` | `//コメント` | PukiWiki独自記法は`~`を削除 |

**エスケープ対象のMarkdown特殊文字:**
- `*` - 見出しやリスト
- `-` - リストや水平線
- `+` - リスト
- `>` - 引用
- `#` - 見出し
- `|` - テーブル

**注意事項:**
- 行頭に空白やタブがある場合は整形済みテキストとして扱われ、変換されません
- Markdown特殊文字以外（PukiWiki独自記法など）は`~`を削除するだけでエスケープしません
- `~`単独の行はそのまま残ります

**例:**
```
入力:
~*これは見出しではありません
テキスト
~&ref(image.png);

出力:
\*これは見出しではありません
テキスト
&ref(image.png);
```

### 5.15 投票プラグイン（#vote）

`#vote`プラグインは、HTMLコメント＋投票結果の表として変換されます。

**変換規則:**

| PukiWiki | Markdown |
|----------|----------|
| `#vote(選択肢1[0],選択肢2[1])` | HTMLコメント + 表形式 |

**例:**

```
入力:
#vote(選択肢1[0],選択肢2[1],選択肢3[3])

出力:
<!-- #vote(選択肢1[0],選択肢2[1],選択肢3[3]) -->
| 選択肢 | 投票数 |
| --- | ---: |
| 選択肢1 | 0 |
| 選択肢2 | 1 |
| 選択肢3 | 3 |
```

**処理内容:**
- 元の`#vote`記法をHTMLコメントとして保存
- 各選択肢と投票数を2カラムの表として出力
- 選択肢の書式: `ラベル[投票数]`
- カウントが指定されていない選択肢はデフォルトで0とする

**注意事項:**
- 投票機能は失われ、静的なスナップショットとして保存されます
- 表は右寄せで投票数を表示します

### 5.16 HTMLコメント化されるプラグイン記法

以下のプラグイン記法は、Markdownでは表現できないため、HTMLコメントとして変換されます。

**変換対象のプラグイン:**

詳細は「5.11 ブロックプラグインのHTMLコメント化」を参照してください。デフォルトで46個のブロックプラグインがHTMLコメント化されます：

- **システムディレクティブ (4個)**: `author`, `freeze`, `nofollow`, `norelated`
- **コンテンツインクルード・表示 (4個)**: `amazon`, `aname`, `include`, `includesubmenu`
- **動的機能・フォーム (10個)**: `article`, `attach`, `comment`, `contents`, `counter`, `insert`, `lookup`, `navi`, `newpage`, `pcomment`
- **リスト・ナビゲーション (10個)**: `back`, `ls`, `ls2`, `menu`, `online`, `popular`, `recent`, `related`, `search`, `topicpath`
- **トラッカー (4個)**: `bugtrack`, `bugtrack_list`, `tracker`, `tracker_list`
- **カレンダー (5個)**: `calendar`, `calendar2`, `calendar_edit`, `calendar_read`, `calendar_viewer`
- **ユーティリティ (9個)**: `clear`, `memo`, `paint`, `random`, `server`, `setlinebreak`, `showrss`, `stationary`, `version`, `versionlist`

**例:**

```
入力:
#contents
*見出し1
**見出し2
#comment
#counter

出力:
<!-- #contents -->
# 見出し1
## 見出し2
<!-- #comment -->
<!-- #counter -->
```

**パラメータ付きプラグイン:**

```
入力:
#contents(depth=2)

出力:
<!-- #contents(depth=2) -->
```

**カスタムプラグインの除外:**

`--exclude-plugins` オプションでカスタムプラグインを追加できます：

```bash
pukiwiki-to-md -w ./wiki -a ./attach -o ./output -x "myplugin,customplugin"
```

**注意事項:**
- これらのプラグインの動的機能は失われます
- HTMLコメントとして保存されることで、元の記述を参照可能
- 必要に応じて手動でMarkdown形式に書き直すことができます

### 5.17 独自変換処理のあるプラグイン

以下のプラグインは、HTMLコメント化せず、Markdown形式に変換されます：

- `#vote` - 投票プラグイン（Markdown表に変換）
- `#br` / `#br()` - 改行プラグイン（`<br>`タグに変換）
- `#hr` / `#hr()` - 水平線プラグイン（`---`に変換）
- `#ref` - ファイル参照プラグイン（Markdown画像/リンクまたは`<img>`タグに変換）
- `&br;` / `&br();` - インライン改行プラグイン（`<br>`タグに変換）

これら以外のプラグイン記法で、除外リストに含まれないものはそのまま残ります。

---

## 6. 添付ファイル処理仕様

### 6.1 検出処理

1. `attach/`フォルダ内のファイルを走査
2. ファイル名のプレフィックス(`_`の前)がエンコードされたページ名と一致するものを抽出
3. 該当ページの添付ファイルとして処理

### 6.2 変換処理

1. **ファイル名デコード**: エンコードされたページ名部分をデコード
2. **ファイル名生成**: `<ページ名>_attachment_<元のファイル名>`
3. **ファイルコピー**: 対応するMarkdownファイルと同じディレクトリにコピー

### 6.3 Markdown内の参照更新

1. `#ref(ファイル名)`などの添付ファイル参照を検出
2. 新しいファイル名に置き換え
3. 相対パスが正しく解決されることを確認

---

## 7. エラーハンドリング仕様

### 7.1 ログ出力

#### 7.1.1 ログ形式

各ファイルの処理結果を以下の形式で出力する:

```
[<STATUS>] <元のファイルパス> → <出力パス> (<詳細情報>)
```

#### 7.1.2 ステータス

| ステータス | 意味 | 使用場面 |
|----------|------|--------|
| SUCCESS | 処理成功 | ページ変換成功、添付ファイルコピー成功 |
| ERROR | 処理失敗 | デコード失敗、変換エラー、ファイル操作エラー |

**注**: 処理対象外のファイル(`:config`ファイル、`.log`ファイル、アンダースコアを含まないファイルなど)は、ファイル収集段階で除外されるため、ログには出力されません。

#### 7.1.3 出力例

```
Starting conversion...
Wiki folder: /path/to/pukiwiki/wiki
Attach folder: /path/to/pukiwiki/attach
Output folder: /path/to/output

Wiki files: 45
Attachment files: 12

[SUCCESS] wiki/A4D7A4EDA4B8A4A7A4AFA4C8.txt → output/プロジェクト.md (converted)
[SUCCESS] wiki/A4D7A4EDA4B8A4A7A4AFA4C82FA4BFA4B9.txt → output/プロジェクト/タスク.md (converted)
[SUCCESS] attach/A4D7A4EDA4B8A4A7A4AFA4C8_A5C0A5A4A5A2A5B0A5E9A5E02E706E67 → output/プロジェクト_attachment_ダイアグラム.png (attachment copied)
[ERROR] wiki/XYZ123.txt → (failed to decode filename)
[ERROR] wiki/A4C6A4B9A4C8.txt → output/テスト.md (encoding conversion failed)

Conversion completed.
```

**注**: 処理対象ファイルの件数は、`:config`ファイルや`.log`ファイルなどを除外した後の数値です。

### 7.2 サマリー出力

処理完了時に以下の統計情報を表示:

```
Completed:
- Pages converted: 45
- Page errors: 2
- Attachments copied: 12
- Attachment errors: 1

Output folder: /path/to/output
```

#### 7.2.1 統計項目

| 項目 | 説明 |
|------|------|
| Pages converted | 正常に変換されたページ数 |
| Page errors | 変換に失敗したページ数 |
| Attachments copied | 正常にコピーされた添付ファイル数 |
| Attachment errors | コピーに失敗した添付ファイル数 |

**注**: スキップされたファイル(`:config`ファイル、`.log`ファイルなど)は統計に含まれません。これらは処理対象として収集されないため、カウントされません。

---

## 8. 制限事項

### 8.1 既知の制限

1. **ファイル名にスペースを含むページ**: 変換に失敗する可能性がある
2. **カスタムプラグイン**: Markdownに変換できず、コメント化または削除される
3. **InterWiki**: 他のWikiへのリンクは通常のURLリンクとして扱う
4. **ページの別名機能**: PukiWikiのページ別名は未サポート

### 8.2 サポート対象外

- PukiWiki固有の動的機能(投票、トラッカーなど)
- スキン・テーマ情報
- ユーザー管理・権限設定
- プラグインの動的な出力

### 8.3 環境要件

- **Node.js**: v18.0.0以上
- **メモリ**: 最低512MB(大規模なwikiの場合はそれ以上)
- **ディスク**: 入力データの2倍以上の空き容量を推奨

## 9. 参考資料

### 9.1 外部リンク
- [PukiWiki公式](https://pukiwiki.sourceforge.io/)
- [PukiWiki整形ルール](https://pukiwiki.sourceforge.io/?FormattingRules)
- [GitHub Flavored Markdown仕様](https://github.github.com/gfm/)

### 9.2 参考記事
- https://qiita.com/tatsurou313/items/95374e14f73c4f2d3b06
- https://qiita.com/tokumoto/items/5e621b5fadb028566c3a
- https://qiita.com/yuki-takei/items/152e20f4421333ae8fd9
