# PukiWiki to Markdown 変換ツール 仕様書

## 1. 概要

### 1.1 目的
PukiWikiのwikiページデータおよび添付ファイルをMarkdown形式に変換し、ファイルシステムに出力する。

### 1.2 スコープ
- **対象**: PukiWikiのwikiフォルダ(ページデータ)とattachフォルダ(添付ファイル)
- **出力**: Markdownファイル、添付ファイル、ディレクトリ構造

---

## 2. CLI仕様

### 2.1 コマンド形式
```bash
pukiwiki-to-md --wiki <wikiフォルダ> --attach <attachフォルダ> --output <出力フォルダ> [オプション]
```

### 2.2 必須オプション

| オプション | 短縮形 | 説明 | 例 |
|----------|-------|------|-----|
| `--wiki` | `-w` | PukiWikiのwikiフォルダパス | `./pukiwiki/wiki` |
| `--attach` | `-a` | PukiWikiのattachフォルダパス | `./pukiwiki/attach` |
| `--output` | `-o` | 出力先フォルダパス | `./output` |

### 2.3 オプション引数

| オプション | 短縮形 | デフォルト値 | 説明 |
|----------|-------|------------|------|
| `--encoding` | `-e` | `utf-8` | 入力ファイルの文字エンコーディング |
| `--help` | `-h` | - | ヘルプを表示 |
| `--version` | `-v` | - | バージョンを表示 |

### 2.4 実行例

```bash
# 基本的な使用方法(UTF-8)
pukiwiki-to-md -w ./pukiwiki/wiki -a ./pukiwiki/attach -o ./output

# EUC-JPエンコーディングのPukiWikiを変換
pukiwiki-to-md -w ./wiki -a ./attach -o ./output --encoding euc-jp

# ヘルプ表示
pukiwiki-to-md --help
```

### 2.5 終了コード

| コード | 説明 |
|-------|------|
| `0` | 正常終了 |
| `1` | エラー終了(ディレクトリが存在しない、権限エラーなど) |

---

## 3. 入力仕様

### 3.1 PukiWiki wikiフォルダ構造

```
wiki/
├── A4C6A4ACA4EFA4B0.txt         # エンコードされたファイル名
├── B5ECBDB1.txt
├── 3AConfig2FPlugin.txt         # :config で始まるファイル(除外対象)
├── index.html                   # ディレクトリインデックス(除外対象)
├── .htaccess                    # アクセス制御(除外対象)
└── ...
```

#### 3.1.1 ファイル名エンコーディング
- **形式**: URLエンコード(パーセント記号なし)
- **エンコード方式**: 2文字ごとに`%`を挿入してURLデコード
- **例**:
  - エンコード済み: `A4C6A4ACA4EFA4B0`
  - デコード処理: `%A4%C6%A4%AC%A4%EF%A4%B0`
  - 結果: `てがわぐ` (EUC-JPバイト列をデコード)

#### 3.1.2 ファイル内容
- **拡張子**: `.txt`
- **文字エンコーディング**: UTF-8またはEUC-JP(--encodingオプションで指定)
- **フォーマット**: PukiWiki記法

#### 3.1.3 処理対象の判定条件

wikiページとして処理するファイルは以下の条件を**すべて満たす**もの:

1. 拡張子が `.txt`
2. ファイル名が `3AConfig` で始まらない(`:config`のエンコード)

この条件により、以下のファイルは自動的に除外される:
- `3AConfig2FPlugin.txt`: 設定ファイル(`:config/Plugin`)
- `index.html`: ディレクトリインデックス(拡張子が`.txt`でない)
- `.htaccess`: アクセス制御ファイル(拡張子が`.txt`でない)

### 3.2 PukiWiki attachフォルダ構造

```
attach/
├── A4C6A4ACA4EFA4B0_A5A4A5E1A5BCA5B82E706E67       # <エンコードされたページ名>_<エンコードされたファイル名>
├── A4C6A4ACA4EFA4B0_A5A4A5E1A5BCA5B82E706E67.log   # 添付ファイルのメタデータ(除外対象)
├── A4C6A4ACA4EFA4B0_A5C9A5ADA5E5A5E1A5F3A5C82E706466
├── index.html                                     # ディレクトリインデックス(除外対象)
├── .htaccess                                      # アクセス制御(除外対象)
└── ...
```

#### 3.2.1 ファイル命名規則
- **形式**: `<エンコードされたページ名>_<エンコードされた添付ファイル名>`
- **エンコード方式**: ページ名とファイル名(拡張子含む)の両方がURLエンコード(パーセント記号なし)
- **区切り文字**: `_`(アンダースコア、エンコードされていない)
- **例**:
  - エンコード済み: `A4C6A4B9A4C8_A5B9A5AFA5EAA5FCA5F3A5B7A5E7A5C3A5C82E706E67`
  - デコード後: ページ名 `テスト` + ファイル名 `スクリーンショット.png` (`.png` = `2E706E67`)

#### 3.2.2 処理対象の判定条件

添付ファイルとして処理するファイルは以下の条件を**すべて満たす**もの:

1. ファイル名が `<文字列>_<文字列>` の形式(アンダースコアを含む)
2. 拡張子が `.log` ではない

この条件により、以下のファイルは自動的に除外される:
- `.log`ファイル: 添付ファイルのメタデータ
- `index.html`: ディレクトリインデックス(アンダースコアを含まない)
- `.htaccess`: アクセス制御ファイル(アンダースコアを含まない)

---

## 4. 出力仕様

### 4.1 ディレクトリ構造

PukiWikiのページ名に含まれる`/`(スラッシュ)をディレクトリ階層として解釈する。

#### 入力例
```
wiki/
├── A4D7A4EDA4B8A4A7A4AFA4C8.txt           # プロジェクト
├── A4D7A4EDA4B8A4A7A4AFA4C82FA4BFA4B9.txt # プロジェクト/タスク
└── ...
```

#### 出力例
```
output/
├── プロジェクト.md
├── プロジェクト/
│   └── タスク.md
└── ...
```

### 4.2 Markdownファイル仕様

#### 4.2.1 ファイル名
- **形式**: `<デコードされたページ名>.md`
- **文字エンコーディング**: UTF-8
- **例**: `プロジェクト概要.md`

#### 4.2.2 ファイル内容
- **フォーマット**: Markdown(GitHub Flavored Markdown準拠)
- **文字エンコーディング**: UTF-8
- **改行コード**: LF(`\n`)

### 4.3 添付ファイル仕様

#### 4.3.1 配置場所
対応するMarkdownファイルと同じディレクトリ

#### 4.3.2 ファイル命名規則
```
<ページ名>_attachment_<元のファイル名>
```

#### 4.3.3 例

| 元のPukiWiki添付ファイル | デコード後 | 出力ファイル名 |
|---------------------|---------|--------------|
| `A4C6A4B9A4C8_A5A4A5E1A5BCA5B82E706E67` | ページ名: `テスト`<br>ファイル名: `イメージ.png` | `テスト_attachment_イメージ.png` |
| `A4D7A4EDA4B8A4A7A4AFA4C8_A5C9A5ADA5E5A5E1A5F3A5C82E706466` | ページ名: `プロジェクト`<br>ファイル名: `ドキュメント.pdf` | `プロジェクト_attachment_ドキュメント.pdf` |

---

## 5. 変換仕様

### 5.1 見出し

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `*見出し1` | `# 見出し1` | レベル1見出し |
| `**見出し2` | `## 見出し2` | レベル2見出し |
| `***見出し3` | `### 見出し3` | レベル3見出し |

**例:**
```
入力: *はじめに
出力: # はじめに
```

### 5.2 リスト

#### 5.2.1 箇条書きリスト

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `-項目` | `- 項目` | レベル1 |
| `--項目` | `    - 項目` | レベル2(インデント4スペース) |
| `---項目` | `        - 項目` | レベル3(インデント8スペース) |

**例:**
```
入力:
-項目1
--項目1-1
---項目1-1-1
-項目2

出力:
- 項目1
    - 項目1-1
        - 項目1-1-1
- 項目2
```

#### 5.2.2 番号付きリスト

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `+項目` | `1. 項目` | レベル1 |
| `++項目` | `    1. 項目` | レベル2(インデント4スペース) |
| `+++項目` | `        1. 項目` | レベル3(インデント8スペース) |

### 5.3 テキスト装飾

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `''強調''` | `**強調**` | 太字 |
| `'''イタリック'''` | `*イタリック*` | 斜体 |
| `%%取り消し%%` | `~~取り消し~~` | 取り消し線 |
| `&br;` | `<br>` | 改行 |

### 5.4 リンク

#### 5.4.1 内部リンク

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `[[ページ名]]` | `[ページ名](ページ名.md)` | 同じディレクトリ |
| `[[ページ名>別ページ]]` | `[ページ名](別ページ.md)` | リンクテキスト指定 |
| `[[カテゴリ/ページ]]` | `[カテゴリ/ページ](カテゴリ/ページ.md)` | 階層リンク |

**階層リンクの相対パス解決:**
```
現在のページ: プロジェクト/タスク.md
リンク: [[プロジェクト/概要]]
出力: [プロジェクト/概要](../プロジェクト/概要.md)
```

#### 5.4.2 外部リンク

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `[[テキスト:https://example.com]]` | `[テキスト](https://example.com)` | |
| `https://example.com` | `https://example.com` | URL直接記述 |

### 5.5 画像・添付ファイル

#### 5.5.1 画像参照

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `#ref(image.png)` | `![](ページ名_attachment_image.png)` | 同じディレクトリの添付ファイル |
| `#ref(image.png,テキスト)` | `![テキスト](ページ名_attachment_image.png)` | altテキスト指定 |

**例:**
```
ページ名: プロジェクト概要
入力: #ref(screenshot.png)
出力: ![](プロジェクト概要_attachment_screenshot.png)
```

#### 5.5.2 添付ファイルリンク

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `&ref(document.pdf);` | `[document.pdf](ページ名_attachment_document.pdf)` | |

### 5.6 コードブロック

#### 5.6.1 整形済みテキスト

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `#pre{{`<br>`コード`<br>`}}` | ` ``` `<br>`コード`<br>` ``` ` | コードブロック |

**例:**
```
入力:
#pre{{
const x = 10;
console.log(x);
}}

出力:
```
const x = 10;
console.log(x);
```
```

#### 5.6.2 インラインコード

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `&code{コード};` | `` `コード` `` | インラインコード |

### 5.7 引用

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `>引用文` | `> 引用文` | |
| `>>引用文` | `> > 引用文` | ネスト引用 |

### 5.8 水平線

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `----` | `---` | 水平線 |

### 5.9 テーブル

#### 5.9.1 基本テーブル

| PukiWiki | Markdown |
|----------|----------|
| `|セル1|セル2|` | `| セル1 | セル2 |` |

**例:**
```
入力:
|ヘッダ1|ヘッダ2|h
|データ1|データ2|

出力:
| ヘッダ1 | ヘッダ2 |
|---------|---------|
| データ1 | データ2 |
```

#### 5.9.2 テーブルヘッダ
- PukiWikiの`|h`記法はMarkdownのヘッダー行として変換
- セパレーター行(`|---|---|`)を自動挿入

### 5.10 プラグイン記法

#### 5.10.1 基本方針
PukiWikiのプラグインはMarkdownには直接対応するものがないため、以下の方針で処理：

1. **コメント化**: プラグインをHTMLコメントとして残す
2. **そのまま残す**: テキストとして残す
3. **削除**: 変換不可能なものは削除してログに記録

#### 5.10.2 よく使われるプラグインの変換

| PukiWiki | Markdown | 備考 |
|----------|----------|------|
| `#contents` | `<!-- TOC -->` | 目次(コメント化) |
| `#ls` | `<!-- #ls -->` | ページ一覧(コメント化) |
| `#lsx` | `<!-- #lsx -->` | ページ一覧拡張(コメント化) |
| `#include(ページ)` | `<!-- #include(ページ) -->` | インクルード(コメント化) |
| `#comment` | (削除) | コメント欄は削除 |

### 5.11 変換対象外

以下の記法は変換せず、そのまま残すか削除する:

- `#vote`: 投票プラグイン(削除)
- `#tracker`: トラッカープラグイン(削除)
- `#calendar`: カレンダープラグイン(削除)
- カスタムプラグイン全般(HTMLコメント化)

---

## 6. 添付ファイル処理仕様

### 6.1 検出処理

1. `attach/`フォルダ内のファイルを走査
2. ファイル名のプレフィックス(`_`の前)がエンコードされたページ名と一致するものを抽出
3. 該当ページの添付ファイルとして処理

### 6.2 変換処理

1. **ファイル名デコード**: エンコードされたページ名部分をデコード
2. **ファイル名生成**: `<ページ名>_attachment_<元のファイル名>`
3. **ファイルコピー**: 対応するMarkdownファイルと同じディレクトリにコピー

### 6.3 Markdown内の参照更新

1. `#ref(ファイル名)`などの添付ファイル参照を検出
2. 新しいファイル名に置き換え
3. 相対パスが正しく解決されることを確認

---

## 7. エラーハンドリング仕様

### 7.1 エラーの分類

#### 7.1.1 致命的エラー(処理中断)

| エラー | 説明 | 終了コード |
|-------|------|----------|
| ディレクトリ不存在 | 指定されたwiki/attachフォルダが存在しない | 1 |
| 権限エラー | フォルダへの読み取り権限がない | 1 |
| 出力先作成失敗 | 出力フォルダの作成に失敗 | 1 |

#### 7.1.2 非致命的エラー(処理継続)

| エラー | 説明 | 処理 |
|-------|------|------|
| ファイル名デコード失敗 | ファイル名のデコードに失敗 | スキップしてログ記録 |
| エンコーディング変換失敗 | 文字エンコーディング変換に失敗 | スキップしてログ記録 |
| 添付ファイル不在 | Markdown内で参照されているが実ファイルがない | 警告ログを出力 |

### 7.2 ログ出力

#### 7.2.1 ログ形式

各ファイルの処理結果を以下の形式で出力する:

```
[<STATUS>] <元のファイルパス> → <出力パス> (<詳細情報>)
```

#### 7.2.2 ステータス

| ステータス | 意味 | 使用場面 |
|----------|------|--------|
| SUCCESS | 処理成功 | ページ変換成功、添付ファイルコピー成功 |
| ERROR | 処理失敗 | デコード失敗、変換エラー、ファイル操作エラー |

**注**: 処理対象外のファイル(`:config`ファイル、`.log`ファイル、アンダースコアを含まないファイルなど)は、ファイル収集段階で除外されるため、ログには出力されません。

#### 7.2.3 出力例

```
Starting conversion...
Wiki folder: /path/to/pukiwiki/wiki
Attach folder: /path/to/pukiwiki/attach
Output folder: /path/to/output

Wiki files: 45
Attachment files: 12

[SUCCESS] wiki/A4D7A4EDA4B8A4A7A4AFA4C8.txt → output/プロジェクト.md (converted)
[SUCCESS] wiki/A4D7A4EDA4B8A4A7A4AFA4C82FA4BFA4B9.txt → output/プロジェクト/タスク.md (converted)
[SUCCESS] attach/A4D7A4EDA4B8A4A7A4AFA4C8_A5C0A5A4A5A2A5B0A5E9A5E02E706E67 → output/プロジェクト_attachment_ダイアグラム.png (attachment copied)
[ERROR] wiki/XYZ123.txt → (failed to decode filename)
[ERROR] wiki/A4C6A4B9A4C8.txt → output/テスト.md (encoding conversion failed)

Conversion completed.
```

**注**: 処理対象ファイルの件数は、`:config`ファイルや`.log`ファイルなどを除外した後の数値です。

### 7.3 サマリー出力

処理完了時に以下の統計情報を表示:

```
Completed:
- Pages converted: 45
- Page errors: 2
- Attachments copied: 12
- Attachment errors: 1

Output folder: /path/to/output
```

#### 7.3.1 統計項目

| 項目 | 説明 |
|------|------|
| Pages converted | 正常に変換されたページ数 |
| Page errors | 変換に失敗したページ数 |
| Attachments copied | 正常にコピーされた添付ファイル数 |
| Attachment errors | コピーに失敗した添付ファイル数 |

**注**: スキップされたファイル(`:config`ファイル、`.log`ファイルなど)は統計に含まれません。これらは処理対象として収集されないため、カウントされません。

---

## 8. 制限事項

### 8.1 既知の制限

1. **ファイル名にスペースを含むページ**: 変換に失敗する可能性がある
2. **カスタムプラグイン**: Markdownに変換できず、コメント化または削除される
3. **InterWiki**: 他のWikiへのリンクは通常のURLリンクとして扱う
4. **ページの別名機能**: PukiWikiのページ別名は未サポート

### 8.2 サポート対象外

- PukiWiki固有の動的機能(投票、トラッカーなど)
- スキン・テーマ情報
- ユーザー管理・権限設定
- プラグインの動的な出力

### 8.3 環境要件

- **Node.js**: v18.0.0以上
- **メモリ**: 最低512MB(大規模なwikiの場合はそれ以上)
- **ディスク**: 入力データの2倍以上の空き容量を推奨

---

## 9. テストケース

### 9.1 ファイル名デコードテスト

| 入力 | 期待される出力 |
|------|--------------|
| `A4C6A4B9A4C8.txt` | `テスト` |
| `B5ECBDB1.txt` | `技術` |
| `A5D7A5EDA5B8A5A7A5AFA5C8.txt` | `プロジェクト` |

### 9.2 見出し変換テスト

| 入力 | 期待される出力 |
|------|--------------|
| `*見出し1` | `# 見出し1` |
| `**見出し2` | `## 見出し2` |
| `***見出し3` | `### 見出し3` |

### 9.3 リスト変換テスト

| 入力 | 期待される出力 |
|------|--------------|
| `-項目1` | `- 項目1` |
| `--項目1-1` | `  - 項目1-1` |
| `+番号1` | `1. 番号1` |

### 9.4 リンク変換テスト

| 入力 | 期待される出力 |
|------|--------------|
| `[[トップページ]]` | `[トップページ](トップページ.md)` |
| `[[GitHub:https://github.com]]` | `[GitHub](https://github.com)` |

### 9.5 添付ファイル処理テスト

**前提:**
- ページ名エンコード: `A4C6A4B9A4C8` → デコード: `テスト`
- 添付ファイル: `attach/A4C6A4B9A4C8_A5A4A5E1A5BCA5B82E706E67`
- ファイル名エンコード: `A5A4A5E1A5BCA5B82E706E67` → デコード: `イメージ.png`

**期待される出力:**
- ファイル: `output/テスト_attachment_イメージ.png`
- Markdown内の参照: `![](テスト_attachment_イメージ.png)`

### 9.6 階層構造テスト

**入力:**
```
wiki/
├── A4D7A4EDA4B8A4A7A4AFA4C8.txt              # プロジェクト
└── A4D7A4EDA4B8A4A7A4AFA4C82FA4BFA4B9.txt    # プロジェクト/タスク
```

**期待される出力:**
```
output/
├── プロジェクト.md
└── プロジェクト/
    └── タスク.md
```

---

## 10. 参考資料

### 10.1 外部リンク
- [PukiWiki公式](https://pukiwiki.osdn.jp/)
- [PukiWiki整形ルール](https://pukiwiki.osdn.jp/?FormattingRules)
- [GitHub Flavored Markdown仕様](https://github.github.com/gfm/)

### 10.2 参考記事
- https://qiita.com/tatsurou313/items/95374e14f73c4f2d3b06
- https://qiita.com/tokumoto/items/5e621b5fadb028566c3a
- https://qiita.com/yuki-takei/items/152e20f4421333ae8fd9
